Protecting web applications is becoming the main focus for most IT departments.
Web attacks now most common attacks against any type of company.
Any external facing server may result in total compromise of the entire company. 
Even if a company has no external facing endpoints they likely use internal web apps or API endpoints which are both vulnerable to the same types of attack. 

## Web Attacks
### HTTP Verb Tampering
Changing the verb in the http request to an unexpected method to bypass security control and authorization mechanisms
### IDOR 
Insecure Direct Object Reference 
Where you are able to bypass authorization and access data not belonging to you by modifying a parameter. 

### XXE XML External Entity
A lot of apps use XML parsing software. Opens up possibility for XXE by poisoning XML FIles. Allows leaking of environment variable and sometimes even source code. 

## Verb Tampering
If web app is not developed to only accept GET/POST we can use other HTTP Verbs to exploit this and possibly gain unauthorized access to a system or bypass security controls.

|           |                                                                                                                                                                                                                                                               |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `HEAD`    | Identical to a GET request, but its response only contains the `headers`, without the response body                                                                                                                                                           |
| `PUT`     | Writes the request payload to the specified location                                                                                                                                                                                                          |
| `DELETE`  | Deletes the resource at the specified location                                                                                                                                                                                                                |
| `OPTIONS` | Shows different options accepted by a web server, like accepted HTTP verbs                                                                                                                                                                                    |
| `PATCH`   | Apply partial modifications to the resource at the specified location                                                                                                                                                                                         |
| `CONNECT` | The **`CONNECT`** HTTP method requests that a [proxy](https://developer.mozilla.org/en-US/docs/Glossary/Proxy_server) establish a HTTP tunnel to a destination server, and if successful, blindly forward data in both directions until the tunnel is closed. |
| ` TRACE`  | The **`TRACE`** HTTP method performs a message loop-back test along the path to the target resource.                                                                                                                                                          |

PUT may be blocked but patch might not be. 

### Insecure Configurations
A web servers authorization functions may be linked to a certain HTTP method. 
```xml
<Limit GET POST>
    Require valid-user
</Limit>
```

 the configuration specifies both `GET` and `POST` requests for the authentication method, an attacker may still use a different HTTP method (like `HEAD`) to bypass this authentication mechanism altogether

### Insecure Coding
This can occur when a developer applies a filter to a certain HTTP method but forgets to apply it to the rest.

If a website is found to be vulnerable to SQL injection and the developer sanitizes get requests he may leave out PUT and POST 

## Bypassing Basic Authentication
Whilst most automated vulnerability scanners will pick up HTTP Tampering from insecure configurations, it cannot pick up HTTP Tampering from insecure coding.

### Exploit
We can click `Change Request Method` in burp. 
Servers will commonly throw `GET` & `POST` into the same camp. 

The `HEAD` HTML request is identical to the `GET` method but does not return a body, however the scripts function would still be called  

To see which requests the server accepts we can send an `OPTIONS` request.

## Bypassing Security Filters
If a security filter is testing for malicious payloads in a `POST` command it may be possible to change it to get with data field as parameters.

## Prevention 
### Insecure Configuration
Servers can be configured to reject `GET` only important to reject all 9 requests as `HEAD` or `OPTIONS` 

Good practice to ignore all `HEAD` requests unless specifically needed for the server.


##  IDOR
Exists Due to lack of access control on back-end
Many developers skip access-control therefore all users may have access to all other user's data on the back-end 
IDOR function calls exist too its not just focused on data.
If API has exposed admin commands we may be able to access them via our standard user-access. 

## Identifying IDORS 
The first step to exploiting IDORS is finding Direct Object References. Whenever we recieve a specific resource we should study the parameters for user ids or identifiers. 

In the most basic cases we can just increment the user ID 

### AJAX Calls
We may be able to identify unused parameters in JS AJAX calls. 
Apps may place all function calls on the front-end and use the appropriate ones based on user role.

### Understanding Hashing/Encoding
Web apps may not just use numbers and may use encoded or hashed identifiers. 
Commonly uses Base64

If a website is using a hashed call it may not be possible and may be secure. 
If we then look at the source code we may be able to see the hashing protocol and reverse it. Or if we see the Hashing protocol with a naming convention then we can hash other files and make attempts at incrimentation

### Compare User Roles
For more advanced IDORS we may need to register multiple users and compare their requests. 

## Mass IDOR Enumeration
Identify Predictable naming patterns then fuzz for files. 
### Mass Enumeration
Manually Accessing files is not a sustainable method in a real work environment with possibly 1000s of users.

We can curl then filter for `<a> ` tags and then clean with REGEX 
```html
<li class='pure-tree_link'><a href='/documents/Invoice_3_06_2020.pdf' target='_blank'>Invoice</a></li>
<li class='pure-tree_link'><a href='/documents/Report_3_01_2020.pdf' target='_blank'>Report</a></li>
```

For example with a website which shows invoice reports like this 
we can curl the document and Grep for specific strings

```shell
Retrosoda@htb[/htb]$ curl -s "http://SERVER_IP:PORT/documents.php?uid=3" | grep -oP "\/documents.*?.pdf"
```

We can then use a for loop to loop over the UID param and wget each document. 
```bash
#!/bin/bash

url="http://SERVER_IP:PORT"

for i in {1..10}; do
        for link in $(curl -s "$url/documents.php?uid=$i" | grep -oP "\/documents.*?.pdf"); do
                wget -q $url/$link
        done
done
```


## Bypassing Encoded Filters
Objects often hashed or encoded via md5 or Base64

Download scripts are common practice to avoid directly linking to files and often use hashed references.

We can attempt to hash common values `IE: uid, username, filename`
`Burp comparer` would come in handy.

### Functional Disclosures
Many web developers preform sensitive functions on the front-end which would expose them to attackers. Worth checking the source code for 

## IDORS in insecure APIs
IDOR API function calls allow us to execute functions as another user. ie Change Private info reset passwords, or buy items with another user's payment information.

## Chaining IDOR Vulnerabilities
Possible to find API endpoints which disclose information to be used in other API endpoints.

## IDOR Preventions
### Object-Level Access Control (IDOR)

- **Core Principle**: Access control is critical for web app security. It manages user roles and permissions, ideally through a centralized system like RBAC (Role-Based Access Control).
    
- **RBAC System**: Maps user roles and privileges to objects/resources. Backend checks if the user has sufficient permissions for access.
    
- **Role Mapping**: Each user is assigned roles that define their permissions. The backend uses session tokens to verify privileges.
    
- **Secure Implementation**: Avoid storing sensitive role data in cookies or user-controllable locations. Use backend authentication (e.g., user tokens) to verify roles securely.
    
- **Code Example** (JavaScript):
    `match /api/profile/{userId} {     allow read, write: if user.isAuth == true     && (user.uid == userId || user.roles == 'admin'); }`

### Object Referencing

- **IDOR Issue**: Insecure direct object referencing can lead to enumeration and exploitation of access control flaws.
    
- **Solution**: Use strong, unique references like UUIDs (e.g., UUID V4). Avoid clear-text or predictable references (e.g., uid=1).
    
- **Backend Management**: Generate and store object references (e.g., salted hashes or UUIDs) in the backend.
    
- **Code Example** (PHP):
    `$uid = intval($_REQUEST['uid']); $query = "SELECT url FROM documents where uid=" . $uid;`
- **UUIDs in Practice**: Can obscure IDOR vulnerabilities, making testing harder but more secure when paired with strong access control.

## Intro to XXE
XML Vulnerabilities occur when XML data is taken from controlled user input without sanitizing or parsing which may allow us to use XML features to preform malicious actions. 

### XML 
eXtensible Markup Language (XML) is a common XML markup language like HTML or JSON designed for flexible transfer and storage of data.
Element 

|   |   |   |
|---|---|---|
|`Tag`|The keys of an XML document, usually wrapped with (`<`/`>`) characters.|`<date>`|
|`Entity`|XML variables, usually wrapped with (`&`/`;`) characters.|`&lt;`|
|`Element`|The root element or any of its child elements, and its value is stored in between a start-tag and an end-tag.|`<date>01-01-2022</date>`|
|`Attribute`|Optional specifications for any element that are stored in the tags, which may be used by the XML parser.|`version="1.0"`/`encoding="UTF-8"`|
|`Declaration`|Usually the first line of an XML document, and defines the XML version and encoding to use when parsing it.|`<?xml version="1.0" encoding="UTF-8"?>`|

some characters are used as part of an XML document structure, like `<`, `>`, `&`, or `"`. So, if we need to use them in an XML document, we should replace them with their corresponding entity references (e.g. `&lt;`, `&gt;`, `&amp;`, `&quot;`). Finally, we can write comments in XML documents between `<!--` and `-->`, similar to HTML documents.

### XML  Document-Type-Declaration
XML allows validation against pre-defined document structure. 
The DTD can be in the XML document or in an external file

*Example DTD*
```xml
<!DOCTYPE email [
  <!ELEMENT email (date, time, sender, recipients, body)>
  <!ELEMENT recipients (to, cc?)>
  <!ELEMENT cc (to*)>
  <!ELEMENT date (#PCDATA)>
  <!ELEMENT time (#PCDATA)>
  <!ELEMENT sender (#PCDATA)>
  <!ELEMENT to  (#PCDATA)>
  <!ELEMENT body (#PCDATA)>
]>
```
the DTD is declaring the root element with the element declaration then declaring child elements. `#PCDATA` is used for declaring raw data.

The DTD can be placed in the document in the line underneath the XML decleration field 