- One of most common critical types of vulnerabilities. Allows execution of commands directly on back end server. \
- Injection of malicious payload to a user input field.

__Number 3 risk in https://owasp.org/www-project-top-ten/__

| Injection                           | Description                                                               |
| ----------------------------------- | ------------------------------------------------------------------------- |
| OS Command Injection                | Occurs when user input is directly used as part of an OS command.         |
| Code Injection                      | Occurs when user input is directly within a function that evaluates code. |
| SQL Injections                      | Occurs when user input is directly used as part of an SQL query.          |
| Cross-Site Scripting/HTML Injection | Occurs when exact user input is displayed on a web page.                  |

Other Types: LDAP injection, NoSQL Injection, HTTP Header Injection, IMAP Injection, ORM Injection. 

### OS Command Injections
Input we control directly must go into a web query that executes system commands. All we programming languages have different functions that enable developer to execute operating system commands on back end. Could be installing plugins or executing applications

_PHP_ :- Exec, system, shell_exec, passsthru, popen 

_Node_ :- child_process.exec, child_process.spawn 

## Detection
If appending command through various injection methods changes intended result then we have successfully exploited the vulnerability. 

| **Injection Operator** | **Injection Character** | **URL-Encoded Character** | **Executed Command**                       |
| ---------------------- | ----------------------- | ------------------------- | ------------------------------------------ |
| Semicolon              | `;`                     | `%3b`                     | Both                                       |
| New Line               | `\n`                    | `%0a`                     | Both                                       |
| Background             | `&`                     | `%26`                     | Both (second output generally shown first) |
| Pipe                   | `\|`                    | `%7c`                     | Both (only second output is shown)         |
| AND                    | `&&`                    | `%26%26`                  | Both (only if first succeeds)              |
| OR                     | `\|`                    | `%7c%7c`                  | Second (only if first fails)               |
| Sub-Shell              | ` `` `                  | `%60%60`                  | Both (Linux-only)                          |
| Sub-Shell              | `$()`                   | `%24%28%29`               |                                            |
can use these operators to inject another command so both or either of the commands get executed. can write expected inputs then use above operators to write new command.

Some are Unix only and do not work on windows

all of these operators can be used for command injections regardless of web application language, framework or back-end. 

; will not work if being executed by windows command line and will only work with powershell.

## Injecting Commands

Include injection operator and then command. 
\
```bash
ping -c 1 127.0.0.1; whoami
```

Check for front end validation with network requests tab. If they're blocked then we can skip with burp.

## Other Injection Operators

### AND Operator &&
Will run second bit of code but only if first command succeeds
### OR Operator ||
Will run injected code only if first line of code fails
Bash command returns successful exit code of 0 after first bit of code so it will stop and not try second command.

| **Injection Type**                      | **Operators**                                     |
| --------------------------------------- | ------------------------------------------------- |
| SQL Injection                           | `'` `,` `;` `--` `/* */`                          |
| Command Injection                       | `;` `&&`                                          |
| LDAP Injection                          | `*` `(` `)` `&` `\|`                              |
| XPath Injection                         | `'` `or` `and` `not` `substring` `concat` `count` |
| OS Command Injection                    | `;` `&` `\|`                                      |
| Code Injection                          | `'` `;` `--` `/* */` `$()` `${}` `#{}` `%{}` `^`  |
| Directory Traversal/File Path Traversal | `../` `..\\` `%00`                                |
| Object Injection                        | `;` `&` `\|`                                      |
| XQuery Injection                        | `'` `;` `--` `/* */`                              |
| Shellcode Injection                     | `\x` `\u` `%u` `%n`                               |
| Header Injection                        | `\n` `\r\n` `\t` `%0d` `%0a` `%09`                |

## Identifying Filters
### Filter/WAF Detection
Security mechanism put in place to blacklist certain commands in http request

### Blacklisted characters
Web applications can blacklist characters and deny requests if http requests contain them. 
To attempt to bypass the WAF we must remove possible restricted characters through trial and error and replace them with alternatives from the table above.

### Bypassing Space Filters 
#### Using New Line
_New line(\n , %0a) character is typically not blacklisted as it may be needed in the payload_
#### Using Tabs
Space is a commonly blacklisted character especially if input should not contain spaces.
_Using Tabs (%09) instead of spaces is a technique that may work_
#### Using $IFS
Using `$IFS` Linux Environment Variable may work since its default value is a space and a tab.
use `$IFS` where a space should be and the variable should be automatically replaced with a space.
#### Using Brace Expansion
We can use Bash's brace expansion feature which automaitcally adds spaces between arguments wrapped between braces. 
``127.0.0.1%0a{ls,-la}``


_Reference Payload of all things for more https://github.com/swisskyrepo/PayloadsAllTheThings_

### Bypassing Other Blacklisted Characters
\/ are often blacklisted as they're utilized to access specific directories in Windows and Linux. 

#### Linux
If we take a look at the `${PATH}` variable 
if we take the first character of the path variable we will end up with a _/_ `${PATH:0:1}`
we can do the same with the `${HOME}` and the `${PWD}` variables

for a _;_ we can use `${LS_COLORS:10:1} `
for a _:_ we can use `${LS_COLORS:4:1}`

The breakdown of commands looks like this `${VARIABLE:STARTINGPOSITION:HOWMANYCHARS}`
#### Windows
The same concept works  for windows machines 

we can `echo` a Windows variable (`%HOMEPATH%` -> `\Users\htb-student`), and then specify a starting position (`~6` -> `\htb-student`), and finally specifying a negative end position, which in this case is the length of the username `htb-student` (`-11` -> `\`) :

```cmd-session
echo %HOMEPATH:~6,-11%
```

We can do the same thing with PowerShell, to call a variable in PowerShell we use the `$env:` tag
we can then specify what character to print with square brackets 

```powershell-session
$env:HOMEPATH[0]
```

We can also use the `Get-ChildItem Env:` PowerShell command to print all environment variables and then pick one of them to produce a character we need.

#### Ascii shifting
`echo $(tr '!-}' '"-~' <<<[)` will shift the `[` symbol by 1 position from 98 `[` to 97 `/`
###### Breaking down `echo $(tr '!-}' '"-~' <<<[)`
we can break it down into 2 sections `tr '!-}` and `'"-~' <<<[ `
>`tr '!-}`
>`tr` is used to translate or delete characters
>`!-}` represents the range of ascii characters from `!(ASCII33)` to `}(ASCII125)`
>`"-~` represents the range of ascii characters  from `"(ASCII32)` to `~(ASCII124)`
>`<<<` is bash's 'here' string it passes the input string to command that follows
>`[` is the given string

- The character `[` is being translated from the set `'!-}'` to the set `'"-~'`.
- `[` (ASCII 91) in the `'!-}'` set corresponds to `\` (ASCII 92) in the `'"-~'` set.
- So, the output of the command will be `\`

## Bypassing Blacklisted Commands
### Commands Blacklist
