## Theory of Protection
CIA Triad
*Confidentiality* 
*Integrity*
*Access*

We keep this balance by ensuring we audit and account (Accounting) for each file, object, and host in our environment; by validating users have correct permissions (Authorization) to view and utilize those items; and ensuring that each user's identity is validated (Authentication) before granting them access to any enterprise resources.

### Authentication
Three main factors for validation 
1. Something you Know (Password)
2. Something you Possess (Keyfob)
3. Something you Are (Fingerprint, Iris)

### Use of Passwords
Passwords are the most common use of authentication. 

## Credential Storage 
### Linux
***/etc/shadows***

|               |                                   |                         |              |              |                     |                        |                      |                    |
| ------------- | --------------------------------- | ----------------------- | ------------ | ------------ | ------------------- | ---------------------- | -------------------- | ------------------ |
| htb-student:  | $y$j9T$3QSBB6CbHEu...SNIP...f8Ms: | 18955:                  | 0:           | 99999:       | 7:                  | :                      | :                    | :                  |
| `<username>`: | `<encrypted password>`:           | `<day of last change>`: | `<min age>`: | `<max age>`: | `<warning period>`: | `<inactivity period>`: | `<expiration date>`: | `<reserved field>` |
`$ <id>``$ <salt>``$ <hashed>`

|**ID**|**Cryptographic Hash Algorithm**|
|---|---|
|`$1$`|[MD5](https://en.wikipedia.org/wiki/MD5)|
|`$2a$`|[Blowfish](https://en.wikipedia.org/wiki/Blowfish_(cipher))|
|`$5$`|[SHA-256](https://en.wikipedia.org/wiki/SHA-2)|
|`$6$`|[SHA-512](https://en.wikipedia.org/wiki/SHA-2)|
|`$sha1$`|[SHA1crypt](https://en.wikipedia.org/wiki/SHA-1)|
|`$y$`|[Yescrypt](https://github.com/openwall/yescrypt)|
|`$gy$`|[Gost-yescrypt](https://www.openwall.com/lists/yescrypt/2019/06/30/1)|
|`$7$`|[Scrypt](https://en.wikipedia.org/wiki/Scrypt)|

### Windows
![[Windows Authentication.png]]
Local interractive logon is preformed by an interraction between WinLogon, LogonUI, The Credential Provider, LSASS, Authentication Processes and SAM/AD.
Authentication packages are dlls that preform authentication checks. 

`Winlogon` is a trusted process responsible for managing security-related user interactions. These include:
- Launching LogonUI to enter passwords at login
- Changing passwords
- Locking and unlocking the workstation

relies on credential providers installed on system to obtain username/pass, located inside DLL files.

#### LSASS
[Local Security Authority Subsystem Service](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service) (`LSASS`) is a collection of many modules and has access to all authentication processes that can be found in `%SystemRoot%\System32\Lsass.exe`.

| **Authentication Packages** | **Description**                                                                                                                                                                                                                                                |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Lsasrv.dll`                | The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful. |
| `Msv1_0.dll`                | Authentication package for local machine logons that don't require custom authentication.                                                                                                                                                                      |
| `Samsrv.dll`                | The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.                                                                                                                                       |
| `Kerberos.dll`              | Security package loaded by the LSA for Kerberos-based authentication on a machine.                                                                                                                                                                             |
| `Netlogon.dll`              | Network-based logon service.                                                                                                                                                                                                                                   |
| `Ntdsa.dll`                 | This library is used to create new records and folders in the Windows registry.                                                                                                                                                                                |
#### SAM Database 
The *Security Account Manager* (`SAM`) is the database file in windows that stores user credentials used to authenticate local and remote users.
User passwords are stored in a `LM` or `NTLM` hash.
`%SystemRoot%/system32/config/SAM`
SYSTEM level permissions are required to view it.

If system is joined to Domain Controller it must first authenticate with DC from the Active Directory Database (`ntds.dit`).  `%SystemRoot%\ntds.dit`

Microsoft introduced a security feature in Windows NT 4.0 to help improve the security of the SAM database against offline software cracking. This is the `SYSKEY` (`syskey.exe`) feature, which, when enabled, partially encrypts the hard disk copy of the SAM file so that the password hash values for all local accounts stored in the SAM are encrypted with a key.

### Credential Manager
![[Pasted image 20241119025220.png]]
### NTDS
Common to come across network environments where windows systems are joined to a windows domain.
Easier for admins to manage all systems owned by their respective orginizations. 
Windows systems will therefore send logon requests to domain controllers that belong to same AD forest. 

Controller hosts a file called `NTDS.dit` that is kept synchronized across all Domain Controllers with the exception of [Read-Only Domain Controllers](https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema). NTDS.dit is a database file that stores the data in Active Directory, including but not limited to:

- User accounts (username & password hash)
- Group accounts
- Computer accounts
- Group policy objects

## Network Services 
Most common services for accessing or executing commands on a remote system are: 
- *RDP*
- *WinRM*
- *SSH*

### WinRM
*Windows Remote Management* (`WinRM`) is ms implementation of WS-Management. It is a network protocol based on XML services and *Simple Object Access Protocol* (`SOAP`) used for remote management of windows system. Takes care of the communication between *Web-Based Enterprise Management* (`wbem`) and *Windows Management Instrumentation* (`WMI`) Which we can call the *Distributed Component Object Model* (`DCOM`). 

*Winrm* uses ports `5985` and `5986` and must be turned on manually for security reasons.

### CrackMapExec
```shell-session
crackmapexec winrm 10.129.42.197 -u user.list -p password.list
```
Useful for bruteforcing passwords in winrm, we can then use *Evil-WinRM* to login.

### Evil-WinRM
If the login was successful, a terminal session is initialized using the [Powershell Remoting Protocol](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-psrp/602ee78e-9a19-45ad-90fa-bb132b7cecec) (`MS-PSRP`)

### SSH 
SSH is a more secure way to remote connect to a host. Runs on *port* `22`. Uses 3 different types of cryptography operations
#### Symmetric Encryption 
Symetric encryption uses the same key for encryption and decryption. Anyone who has access to the key can also transmit data. Key exchange procedure needed for secure encryption. 

#### Asymmetric Encryption 
Asymmetric encryption uses two keys, public and private key. The private key must remain secret. If an attacker gets the private key then they will be able to log into a system without authentication. 
*Hydra can be used to bruteforce SSH*
```shell-session
 hydra -L user.list -P password.list ssh://10.129.42.197
```

### RDP 
*Remote Desktop Protocol* (`RDP`) is a protocol to access windows systems on *port* `3389`
Provides both admins and users to a windows host within an organisation. 
Defines 2 participants, a *Terminal Server* and *Terminal Client*.
In addition to exchange of Sound, Keyboard, Mouse you can also print or allow access to storage media. 
RDP is an application layer protocol and utilizes UDP and TCP.
*Hydra can be used to bruteforce RDP*
```shell-session
hydra -L user.list -P password.list rdp://10.129.42.197
```

### SMB
*Server Message Block*(`SMB`) is a protocol responsible for transferring data between client and server in a LAN. Used to impliment file sharing, directory sharing and printing services. Compared to NFS for linux. 
SMB aka *Common Internet Files System*(`CIFS`) is part of SMB and allows connections from windows. nix. or mac. 
*Hydra can be used to bruteforce SMB*
```shell-session
hydra -L user.list -P password.list smb://10.129.42.197
```

***HYDRA CANNOT HANDLE SMBV3 REQUESTS. USE METASPLOIT***
```shell-session
auxiliary/scanner/smb/smb_login
```

Once we have the SMB Server credentials cracked
We can use CrackMap again to enumerate SMB shares. 

```shell-session
crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares
```

Finally using smbclient to connect to smb shares.

```shell-session
smbclient -U user \\\\10.129.42.197\\SHARENAME
```

cassie:12345678910

## Password Mutations
Hashcat can use specific rule files to create mutations of passwords. 

| **Function** | **Description**                                   |
| ------------ | ------------------------------------------------- |
| `:`          | Do nothing.                                       |
| `l`          | Lowercase all letters.                            |
| `u`          | Uppercase all letters.                            |
| `c`          | Capitalize the first letter and lowercase others. |
| `sXY`        | Replace all instances of X with Y.                |
| `$!`         | Add the exclamation character at the end.         |
***PREBUILT RULESLISTS***
```shell-session
ls /usr/share/hashcat/rules/
```

## Default Passwords. 
https://github.com/ihebski/DefaultCreds-cheat-sheet